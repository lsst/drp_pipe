description: DRP Pipeline for LSSTComCam
instrument: lsst.obs.lsst.LsstComCam
imports:
  - location: $DRP_PIPE_DIR/pipelines/_ingredients/LSSTComCam/DRP.yaml
tasks:
  analyzeMatchedVisitCore:
    class: lsst.analysis.tools.tasks.AssociatedSourcesTractAnalysisTask
    config:
      applyAstrometricCorrections: true
  sourceObjectMatch:
    class: lsst.analysis.tools.tasks.SourceObjectTableAnalysisTask
    config:
      applyAstrometricCorrections: true
subsets:
  step1:
    subset:
      - isr
      - calibrateImage
      - transformPreSourceTable
    description: |
      Per-detector tasks that can be run together to start the DRP pipeline.

      These should never be run with 'tract' or 'patch' as part of the data ID
      expression if any later steps will also be run, because downstream steps
      require full visits and 'tract' and 'patch' constraints will always
      select partial visits that overlap that region.
  step2a:
    subset:
      - consolidatePreSourceTable
      - consolidateVisitSummary
    description: |
      Visit-level tasks
      Allowed data query constraints: visit

      Tasks aggregate all detectors for a given visit and perform
      full focal plane background estimation.

      TODO: Evaluate SkyCorr after intial DRP
  step2b:
    subset:
      - analyzeMatchedPreVisitCore
      - isolatedStarAssociation
      - gbdesAstrometricFit
    description: |
      Tract-level tasks
      Allowed data query constraints: tract

      GbdesAstrometricFit and isolatedStarAssociation both use PreSources,
      generated by consolidatePreSourceTable, for all visits that overlap a
      tract.
      gbdesAstrometricFit produces solutions per-tract, per-visit
      isolatedStarAssociation produces solutions per-tract.
      TODO: Evaluate GBDES after first DRP
  step2c:
    subset:
      - fgcmBuildFromIsolatedStars
      - fgcmFitCycle
      - fgcmOutputProducts
    description: |
      This subset is the FGCM run that runs in "global" mode, which means
      that one should only use an `instrument` and a `skymap` connection
      (the latter of which links with the correct isolated star tables).
  step2d:
    subset:
      - finalizeCharacterization
      - writeRecalibratedSourceTable
      - transformSourceTable
      - consolidateSourceTable
      - updateVisitSummary
    description: |
      Visit-level tasks.
      Allowed data query constraints: visit

      writeRecalibratedSourceTable, transformSourceTable run per-detector
      consolidateSourceTable produces one data product per visit.
      finalizeCharacterization will eventually model full focal plane PSFs.
  step2e:
    subset:
      - makeCcdVisitTable
      - makeVisitTable
    description: |
      Global-level tasks that must not be run with any data query constraints
      Can be run anytime after subset step2d.

      Allowed data query constraints: instrument

      Tasks generate one data product per collection.
      make[Ccd]VisitTable produces per-collection summary of the Visits
      and CcdVisits.
  step3a:
    subset:
      - makeDirectWarp
      - makePsfMatchedWarp
      - selectDeepCoaddVisits
      - assembleCoadd
      - detection
      - mergeDetections
      - deblend
      - measure
      - mergeMeasurements
      - forcedPhotCoadd
      - fitDeepCoaddPsfGaussians
      - fitDeblendedObjectsSersic
      - transformObjectTable
      - writeObjectTable
      - selectGoodSeeingVisits
      - templateGen
    description: |
      Patch-level tasks that can be run together after the 'step2d'
      subsets.
  step3b:
    subset:
      - healSparsePropertyMaps
      - consolidateObjectTable
      # analysis_tools tasks
      - analyzeMatchedVisitCore
      - analyzeObjectTableCore
      - catalogMatchTract
      - photometricCatalogMatch
      - photometricRefCatObjectTract
      - plotPropertyMapTract
      - refCatObjectTract
      - validateObjectTableCore
      - objectEpochTable
    description: |
      Tract-level tasks that can be run together after the 'step3a'
      subsets.
  step4:
    subset:
      - reprocessVisitImage
      - forcedPhotCcd
      - forcedPhotDiffim
      - getTemplate
      - subtractImages
      - detectAndMeasureDiaSources
      - rbClassify
      - transformDiaSourceCat
      - writeForcedSourceTable
    description: |
      Tasks that can be run together, but only after the 'step1', 'step2d' and
      'step3' subsets

      These detector-level tasks should not be run with 'tract' or 'patch' as
      part of the data ID expression if all reference catalogs or diffIm
      templates that cover these detector-level quanta are desired.
  step5:
    subset:
      - drpAssociation
      - drpDiaCalculation
      - forcedPhotCcdOnDiaObjects
      - forcedPhotDiffOnDiaObjects
      - transformForcedSourceTable
      - consolidateAssocDiaSourceTable
      - consolidateFullDiaObjectTable
      - writeForcedSourceOnDiaObjectTable
      - transformForcedSourceOnDiaObjectTable
      - analyzeDiaSourceTableTract
    description: |
      Tasks that can be run together, but only after the 'step1', 'step2',
      'step3', and 'step4' subsets

      This step includes patch-level aggregation Tasks. These should be run
      with explicit 'tract' constraints in the data query, otherwise quanta
      will be created for jobs with only partial visit coverage.
  step6:
    subset:
      - consolidateDiaSourceTable
      - sourceObjectMatch
    description: |
      Tasks that can be run together, but only after the 'step1', 'step2',
      'step3', and 'step4' subsets

      This step includes visit-level aggregation tasks. Running without tract
      or patch in the data query is recommended, otherwise the outputs of
      consolidateDiaSourceTable will not contain complete visits.

      This subset is separate from step4 to signal to operators to pause to
      assess unexpected image differencing failures before these aggregation
      steps. Otherwise, if run in the same quantum graph, aggregated data
      products (e.g. diaObjects) would not be created if one or more of the
      expected inputs is missing.
  step7:
    subset:
      - consolidateHealSparsePropertyMaps
      - analyzeObjectTableSurveyCore
      - makeMetricTableMatchedVisitCore
      - makeMetricTableObjectTableCore
      - matchedVisitCoreWholeSkyPlot
      - objectTableCoreWholeSkyPlot
    description: |
      Tasks that should be run as the final step that require global inputs,
      and can be run after the 'step3' subset.

      This step has global aggregation tasks to run over all visits, detectors,
      tracts, etc.  This step should be run only with the instrument constraint
      in the data query.
