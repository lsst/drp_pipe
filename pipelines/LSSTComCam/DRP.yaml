description: DRP Pipeline for LSSTComCam
instrument: lsst.obs.lsst.LsstComCam
imports:
  - location: $DRP_PIPE_DIR/pipelines/_ingredients/LSSTComCam/DRP.yaml
    labeledSubsetModifyMode: EDIT
    exclude:
      - fgcm
      # TODO[DM-47010]: exclusion is historical, possibly unintentional
      - analysis_drp_plots
      - exposureQualityCore
    # TODO[DM-47010]: inclusion is historical, possibly unintentional
  - $ANALYSIS_TOOLS_DIR/pipelines/coaddQualityExtended.yaml
tasks:
  updateVisitSummary:
    class: lsst.drp.tasks.update_visit_summary.UpdateVisitSummaryTask
    config:
      wcs_provider: "tract"
      photo_calib_provider: "input_summary"
      background_provider: "input_summary"
subsets:
  # step1 is imported
  step2a:
    subset:
      - consolidatePreSourceTable
      - consolidateVisitSummary
    description: |
      Visit-level tasks
      Allowed data query constraints: visit

      Tasks aggregate all detectors for a given visit and perform
      full focal plane background estimation.

      TODO: Evaluate SkyCorr after intial DRP
  step2b:
    subset:
      - analyzeMatchedPreVisitCore
      - isolatedStarAssociation
      - gbdesAstrometricFit
    description: |
      Tract-level tasks
      Allowed data query constraints: tract

      GbdesAstrometricFit and isolatedStarAssociation both use PreSources,
      generated by consolidatePreSourceTable, for all visits that overlap a
      tract.
      gbdesAstrometricFit produces solutions per-tract, per-visit
      isolatedStarAssociation produces solutions per-tract.
      TODO: Evaluate GBDES after first DRP
  step2d:
    subset:
      - finalizeCharacterization
      - transformSourceTable
      - consolidateSourceTable
      - updateVisitSummary
      - reprocessVisitImage
    description: |
      Visit-level tasks.
      Allowed data query constraints: visit

      reprocessVisitImage, transformSourceTable run per-detector.
      consolidateSourceTable produces one data product per visit.
      finalizeCharacterization will eventually model full focal plane PSFs.
  step2e:
    subset:
      - makeCcdVisitTable
      - makeVisitTable
    description: |
      Global-level tasks that must not be run with any data query constraints
      Can be run anytime after subset step2d.

      Allowed data query constraints: instrument

      Tasks generate one data product per collection.
      make[Ccd]VisitTable produces per-collection summary of the Visits
      and CcdVisits.
  # step3 is imported.
  # step4 is imported.
  # step5 is imported.
  # step6 is imported.
  step7:
    subset:
      - consolidateHealSparsePropertyMaps
      - analyzeObjectTableSurveyCore
      - makeMetricTableMatchedVisitCore
      - makeMetricTableObjectTableCore
      - matchedVisitCoreWholeSkyPlot
      - objectTableCoreWholeSkyPlot
    description: |
      Tasks that should be run as the final step that require global inputs,
      and can be run after the 'step3' subset.

      This step has global aggregation tasks to run over all visits, detectors,
      tracts, etc.  This step should be run only with the instrument constraint
      in the data query.
