description: Match tract-level injected_deep_coadd_predetection_catalog datasets to injected_object datasets.
imports:
  - location: $SOURCE_INJECTION_DIR/pipelines/match_injected_tract_catalog.yaml
tasks:
  consolidate_injected_catalogs:
    class: lsst.source.injection.utils.ConsolidateInjectedCatalogsTask
    config:
      connections.input_catalogs: injected_deep_coadd_predetection_catalog
      connections.output_catalog: injected_deep_coadd_predetection_catalog_tract
      columns_extra: ["n", "half_light_radius", "q", "beta"]
      groupIdKey: group_id
      pixel_match_radius: -1
  match_object_to_injected:
    class: lsst.pipe.tasks.match_tract_catalog.MatchTractCatalogTask
    config:
      connections.name_input_cat_ref: injected_deep_coadd_predetection_catalog_tract
      connections.name_input_cat_target: injected_object_all
  compare_object_to_injected:
    class: lsst.pipe.tasks.diff_matched_tract_catalog.DiffMatchedTractCatalogTask
    config:
      connections.name_input_cat_ref: injected_deep_coadd_predetection_catalog_tract
      connections.name_input_cat_target: injected_object_all
  diff_matched_analysis:
    class: lsst.analysis.tools.tasks.DiffMatchedAnalysisTask
    config:
      connections.inputName: matched_injected_deep_coadd_predetection_catalog_tract_injected_object_all
      connections.outputName: matched_injected_deep_coadd_predetection_catalog_tract_injected_object_all

      atools.matchedRefCompleteness: MatchedRefCoaddCompurityTool
      atools.matchedRefAngularSeparationDiff: MatchedRefCoaddDiffDistanceTool
      atools.matchedRefAngularSeparationDiffZoom: MatchedRefCoaddDiffDistanceZoomTool
      atools.matchedRefAngularSeparationChi: MatchedRefCoaddChiDistanceTool
      atools.matchedRefCModelColorDiff: MatchedRefCoaddDiffColorTool
      atools.matchedRefCModelColorDiffZoom: MatchedRefCoaddDiffColorZoomTool
      atools.matchedRefCModelColorChi: MatchedRefCoaddChiColorTool
      atools.matchedRefCModelMagDiff: MatchedRefCoaddDiffMagTool
      atools.matchedRefCModelMagDiffZoom: MatchedRefCoaddDiffMagZoomTool
      atools.matchedRefCModelMagChi: MatchedRefCoaddChiMagTool
      atools.matchedRefGaap1p0ColorDiff: MatchedRefCoaddDiffColorTool
      atools.matchedRefGaap1p0ColorDiff.mag_y1: gaap1p0_err
      atools.matchedRefGaap1p0ColorDiffZoom: MatchedRefCoaddDiffColorZoomTool
      atools.matchedRefGaap1p0ColorDiffZoom.mag_y1: gaap1p0_err
      atools.matchedRefGaap1p0ColorChi: MatchedRefCoaddChiColorTool
      atools.matchedRefGaap1p0ColorChi.mag_y1: gaap1p0_err
      atools.matchedRefGaap1p0MagDiff: MatchedRefCoaddDiffMagTool
      atools.matchedRefGaap1p0MagDiff.mag_y: gaap1p0_err
      atools.matchedRefGaap1p0MagDiffZoom: MatchedRefCoaddDiffMagZoomTool
      atools.matchedRefGaap1p0MagDiffZoom.mag_y: gaap1p0_err
      atools.matchedRefGaap1p0MagChi: MatchedRefCoaddChiMagTool
      atools.matchedRefGaap1p0MagChi.mag_y: gaap1p0_err
      atools.matchedRefKronColorDiff: MatchedRefCoaddDiffColorTool
      atools.matchedRefKronColorDiff.mag_y1: kron_err
      atools.matchedRefKronColorDiffZoom: MatchedRefCoaddDiffColorZoomTool
      atools.matchedRefKronColorDiffZoom.mag_y1: kron_err
      atools.matchedRefKronColorChi: MatchedRefCoaddChiColorTool
      atools.matchedRefKronColorChi.mag_y1: kron_err
      atools.matchedRefKronMagDiff: MatchedRefCoaddDiffMagTool
      atools.matchedRefKronMagDiff.mag_y: kron_err
      atools.matchedRefKronMagDiffZoom: MatchedRefCoaddDiffMagZoomTool
      atools.matchedRefKronMagDiffZoom.mag_y: kron_err
      atools.matchedRefKronMagChi: MatchedRefCoaddChiMagTool
      atools.matchedRefKronMagChi.mag_y: kron_err
      atools.matchedRefPsfColorDiff: MatchedRefCoaddDiffColorTool
      atools.matchedRefPsfColorDiff.mag_y1: psf_err
      atools.matchedRefPsfColorDiffZoom: MatchedRefCoaddDiffColorZoomTool
      atools.matchedRefPsfColorDiffZoom.mag_y1: psf_err
      atools.matchedRefPsfColorChi: MatchedRefCoaddChiColorTool
      atools.matchedRefPsfColorChi.mag_y1: psf_err
      atools.matchedRefPsfMagDiff: MatchedRefCoaddDiffMagTool
      atools.matchedRefPsfMagDiff.mag_y: psf_err
      atools.matchedRefPsfMagDiffZoom: MatchedRefCoaddDiffMagZoomTool
      atools.matchedRefPsfMagDiffZoom.mag_y: psf_err
      atools.matchedRefPsfMagChi: MatchedRefCoaddChiMagTool
      atools.matchedRefPsfMagChi.mag_y: psf_err
      atools.matchedRefSersicColorDiff: MatchedRefCoaddDiffColorTool
      atools.matchedRefSersicColorDiff.mag_y1: sersic_err
      atools.matchedRefSersicColorDiffZoom: MatchedRefCoaddDiffColorZoomTool
      atools.matchedRefSersicColorDiffZoom.mag_y1: sersic_err
      atools.matchedRefSersicColorChi: MatchedRefCoaddChiColorTool
      atools.matchedRefSersicColorChi.mag_y1: sersic_err
      atools.matchedRefSersicMagDiff: MatchedRefCoaddDiffMagTool
      atools.matchedRefSersicMagDiff.mag_y: sersic_err
      atools.matchedRefSersicMagDiffZoom: MatchedRefCoaddDiffMagZoomTool
      atools.matchedRefSersicMagDiffZoom.mag_y: sersic_err
      atools.matchedRefSersicMagChi: MatchedRefCoaddChiMagTool
      atools.matchedRefSersicMagChi.mag_y: sersic_err

      atools.matchedRefPositionRaDiff: MatchedRefCoaddDiffCoordRaTool
      atools.matchedRefPositionRaDiffZoom: MatchedRefCoaddDiffCoordRaZoomTool
      atools.matchedRefPositionRaChi: MatchedRefCoaddChiCoordRaTool
      atools.matchedRefPositionDecDiff: MatchedRefCoaddDiffCoordDecTool
      atools.matchedRefPositionDecDiffZoom: MatchedRefCoaddDiffCoordDecZoomTool
      atools.matchedRefPositionDecChi: MatchedRefCoaddChiCoordDecTool

      atools.matchedRefPositionSersicRaDiff: MatchedRefCoaddDiffCoordRaTool
      atools.matchedRefPositionSersicRaDiff.coord_meas: sersic_ra
      atools.matchedRefPositionSersicRaDiffZoom: MatchedRefCoaddDiffCoordRaZoomTool
      atools.matchedRefPositionSersicRaDiffZoom.coord_meas: sersic_ra
      atools.matchedRefPositionSersicRaChi: MatchedRefCoaddChiCoordRaTool
      atools.matchedRefPositionSersicRaChi.coord_meas: sersic_ra
      atools.matchedRefPositionSersicDecDiff: MatchedRefCoaddDiffCoordDecTool
      atools.matchedRefPositionSersicDecDiff.coord_meas: sersic_dec
      atools.matchedRefPositionSersicDecDiffZoom: MatchedRefCoaddDiffCoordDecZoomTool
      atools.matchedRefPositionSersicDecDiffZoom.coord_meas: sersic_dec
      atools.matchedRefPositionSersicDecChi: MatchedRefCoaddChiCoordDecTool
      atools.matchedRefPositionSersicDecChi.coord_meas: sersic_dec

      python: |
        from lsst.analysis.tools.atools.diffMatched import *
        from lsst.analysis.tools.actions.vector.selectors import InjectedGalaxySelector, InjectedStarSelector

        InjectedGalaxySelector.key_class.default = parameters.source_type_column
        InjectedStarSelector.key_class.default = parameters.source_type_column

        reconfigure_diff_matched_defaults(
          config=config,
          context="injection",
          key_flux_meas="cmodel_err",
          use_any=True,
          use_galaxies=True,
          use_stars=True,
          bands_color=list(parameters.bands_injected),
        )
