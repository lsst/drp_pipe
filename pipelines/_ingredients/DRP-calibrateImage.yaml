description:
  DRP Pipeline that uses calibrateImage instead of calibrate.
imports:
  - location: $DRP_PIPE_DIR/pipelines/_ingredients/DRP-full.yaml
tasks:
  calibrateImage:
    class: lsst.pipe.tasks.calibrateImage.CalibrateImageTask
    config:
      python: |
        config.star_measurement.plugins["base_CircularApertureFlux"].radii = [3.0, 6.0, 9.0, 12.0, 17.0, 25.0, 35.0, 50.0, 70.0]
        config.star_measurement.plugins.names |=  ['base_LocalBackground']
  #writePreSourceTable:
  #  # If we're willing to run this, its a ~3 line change in postprossessing
  #  # but added a shim to transform so we can just skip this altogether
  #  # messier code but one less intermediate dataproduct.
  #  class: lsst.pipe.tasks.postprocess.WriteSourceTableTask
  #  config:
  #    connections.outputCatalog: preSource
  #    connections.catalog: initial_stars_detector
  #    fromAstropy: True
  transformInitialStars:
    class: lsst.pipe.tasks.postprocess.TransformSourceTableTask
    config:
      fromAstropy: true
      connections.inputCatalog: initial_stars_detector
      connections.outputCatalog: preSourceTable
      python: >
        config.functorFile = os.path.join('$PIPE_TASKS_DIR', 'schemas', 'PreSource.yaml')
  consolidateVisitSummary:
      class: lsst.pipe.tasks.postprocess.ConsolidateVisitSummaryTask
      config:
        calexp: initial_pvi
  writeRecalibratedSourceTable: # Works but isn't what we want.
    class: lsst.pipe.tasks.postprocess.WriteRecalibratedSourceTableTask
    config:
      connections.outputCatalog: source
      connections.catalog: initial_stars_footprints_detector
  finalizeCharacterization:
    class: lsst.pipe.tasks.finalizeCharacterization.FinalizeCharacterizationTask
    config:
      connections.calexps: initial_pvi
      connections.srcs: initial_stars_footprints_detector
      connections.src_schema: initial_stars_schema
  updateVisitSummary:
    class: lsst.drp.tasks.update_visit_summary.UpdateVisitSummaryTask
    config:
      connections.background_originals: initial_pvi_background
      connections.input_exposures: initial_pvi
  skyCorr:
    class: lsst.pipe.tasks.skyCorrection.SkyCorrectionTask
    config:
      connections.calExps: initial_pvi
      connections.calBkgs: initial_pvi_background
  isolatedStarAssociation:
    class: lsst.pipe.tasks.isolatedStarAssociation.IsolatedStarAssociationTask
    config:
      connections.source_table_visit: preSourceTable_visit
