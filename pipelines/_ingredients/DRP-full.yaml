description:
  Base Pipeline for Data Release Production process, with full multi-epoch
  calibration and characterizations.

  Never run this pipeline or any of its subsets directly; always use those in
  the 'pipelines' directory (or create a custom one) instead.
imports:
  - location: $DRP_PIPE_DIR/pipelines/_ingredients/DRP-minimal-calibration.yaml
tasks:
  isr:
    class: lsst.ip.isr.IsrTask
    config:
      # Although we don't have to apply the amp offset corrections, we do want
      # to compute them for analyzeAmpOffsetMetadata to report on as metrics.
      doAmpOffset: true
      ampOffset.doApplyAmpOffset: false
  skyCorr:
    class: lsst.pipe.tasks.skyCorrection.SkyCorrectionTask
  isolatedStarAssociation:
    # for global calibration and PSF estimates on preSources
    class: lsst.pipe.tasks.isolatedStarAssociation.IsolatedStarAssociationTask
    config:
      # TODO DM-43077: delete these three overrides.
      # preSource is task default. DM-43077 will remove the overrides to use
      # sourceTable catalogs in DRP-minimal-calibration, and eliminate the
      # need for these:
      connections.source_table_visit: preSourceTable_visit
      connections.isolated_star_sources: isolated_star_presources
      connections.isolated_star_cat: isolated_star_presource_associations
  isolatedStarSourceAssociation:
    # for final repeatability metrics on final source table
    class: lsst.pipe.tasks.isolatedStarAssociation.IsolatedStarAssociationTask
    config:
      connections.source_table_visit: sourceTable_visit
      connections.isolated_star_sources: isolated_star_sources
      connections.isolated_star_cat: isolated_star_source_associations
  finalizeCharacterization:
    class: lsst.pipe.tasks.finalizeCharacterization.FinalizeCharacterizationTask
    config:
      # TODO DM-43077: delete these two overrides. preSource is task default
      connections.isolated_star_cats: isolated_star_presource_associations
      connections.isolated_star_sources: isolated_star_presources
  gbdesAstrometricFit:
    class: lsst.drp.tasks.gbdesAstrometricFit.GbdesAstrometricFitTask
  fgcmBuildFromIsolatedStars:
    class: lsst.fgcmcal.fgcmBuildFromIsolatedStars.FgcmBuildFromIsolatedStarsTask
  fgcmFitCycle:
    class: lsst.fgcmcal.fgcmFitCycle.FgcmFitCycleTask
  fgcmOutputProducts:
    class: lsst.fgcmcal.fgcmOutputProducts.FgcmOutputProductsTask
  transformPreSourceTable:
    class: lsst.pipe.tasks.postprocess.TransformSourceTableTask
    config:
      connections.inputCatalog: initial_stars_detector
      connections.outputCatalog: preSourceTable
      python: |
        import os.path
        config.functorFile = os.path.join("$PIPE_TASKS_DIR", "schemas", "initial_stars_detector_standardized.yaml")
  consolidatePreSourceTable:
    class: lsst.pipe.tasks.postprocess.ConsolidateSourceTableTask
    config:
      connections.inputCatalogs: preSourceTable
      connections.outputCatalog: preSourceTable_visit
  updateVisitSummary:
    class: lsst.drp.tasks.update_visit_summary.UpdateVisitSummaryTask
    config:
      wcs_provider: "tract"
      photo_calib_provider: "global"
      background_provider: "replacement"
  reprocessVisitImage:
    class: lsst.drp.tasks.reprocess_visit_image.ReprocessVisitImageTask
    config:
      do_use_sky_corr: true
  measure:
    class: lsst.pipe.tasks.multiBand.MeasureMergedCoaddSourcesTask
    config:
      connections.sourceTableHandles: preSourceTable_visit
  makePreliminaryCcdVisitTable:
    class: lsst.pipe.tasks.postprocess.MakeCcdVisitTableTask
    config:
      connections.visitSummaryRefs: visitSummary
      connections.outputCatalog: preCcdVisitTable
  makePreliminaryVisitTable:
    class: lsst.pipe.tasks.postprocess.MakeVisitTableTask
    config:
      connections.visitSummaries: visitSummary
      connections.outputCatalog: preVisitTable
  reprocessVisitImage:
    class: lsst.drp.tasks.reprocess_visit_image.ReprocessVisitImageTask
subsets:
  # This pipeline file only defines subsets that have a consistent or
  # near-consistent definition as a set of tasks, for use by downstream
  # pipelines as way to include or exclude those tasks.  It does not (and
  # should not) contain "step" subsets aimed at splitting up a processing
  # campaign.
  fgcm:
    subset:
      - fgcmBuildFromIsolatedStars
      - fgcmFitCycle
      - fgcmOutputProducts
    description: |
      Subset that includes all FGCM tasks.
  preSourceTable:
    subset:
      - transformPreSourceTable
      - consolidatePreSourceTable
    description: >
      Set of tasks to generate parquet PreSource Tables, from single-visit
      processing steps only.
  sourceTable:
    subset:
      - reprocessVisitImage
    description: >
      Set of tasks to generate parquet Source Tables, using final
      calibrations.
