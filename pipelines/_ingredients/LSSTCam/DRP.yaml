description: LSSTCam specialization of the DRP pipeline
instrument: lsst.obs.lsst.LsstCam
imports:
  - location: $DRP_PIPE_DIR/pipelines/_ingredients/base-v2.yaml
    labeledSubsetModifyMode: EDIT
    exclude:
      - analysis-visit-initial
      - analysis-visit-recalibrated
      - analysis-visit-source
      - step2b-recalibrate-tracts
parameters:
  extinctionCoeffs: {"u": 4.75, "g": 3.66, "r": 2.70, "i": 2.05, "z": 1.59, "y": 1.31,}
tasks:
  updateVisitSummary:
    class: lsst.drp.tasks.update_visit_summary.UpdateVisitSummaryTask
    config:
      photo_calib_provider: global
      background_provider: input_summary
      wcs_provider: healpix3
      connections.background_originals: preliminary_visit_image_background
  selectTemplateCoaddVisits:
    class: lsst.pipe.tasks.selectImages.BestSeeingSelectVisitsTask
    config:
      connections.visitSummaries: visit_summary
      connections.goodVisits: template_coadd_visit_selection
      maxPsfFwhm: 1.4
      python: |
        config.visitSummaryMinValues = {'effTimeZeroPointScale': 0.75}
  selectDeepCoaddVisits:
    class: lsst.pipe.tasks.selectImages.BestSeeingSelectVisitsTask
    config:
      maxPsfFwhm: 1.7
      python: |
        config.visitSummaryMinValues = {'effTimeZeroPointScale': 0.75}
  splitPrimarySource:
    class: lsst.pipe.tasks.split_primary.SplitPrimaryTask
    config:
      connections.primary: source2
  detectCoaddPeaks:
    class: lsst.pipe.tasks.multiBand.DetectCoaddSourcesTask
    config:
      # As of w_2025_30 DRP, lowest number of skyObjects seen is 9
      # 9/0.02 = 450.
      detection.skyObjects.nSources: 400
      # Start with HSC configs and then refine
      detection.doTempWideBackground: true
      detection.tempWideBackground.binSize: 128
      detection.tempWideBackground.useApprox: false
      detection.reEstimateBackground: true
      detection.background.binSize: 128
      detection.background.useApprox: false
  # TODO: DM-52176 Turn astrometric corrections back on when final version of
  # proper motion and parallax catalog is available.
  analyzeRecalibratedStarAssociation:
    class: lsst.analysis.tools.tasks.AssociatedSourcesTractAnalysisTask
    config:
      applyAstrometricCorrections: false
  analyzeRecalibratedStarObjectMatch:
    class: lsst.analysis.tools.tasks.SourceObjectTableAnalysisTask
    config:
      applyAstrometricCorrections: false
  analyzeSourceAssociation:
    class: lsst.analysis.tools.tasks.AssociatedSourcesTractAnalysisTask
    config:
      applyAstrometricCorrections: false
  calibrateImage:
    class: lsst.pipe.tasks.calibrateImage.CalibrateImageTask
    config:
      useButlerCamera: True
  analyzeObjectTableCore:
    class: lsst.analysis.tools.tasks.ObjectTableTractAnalysisTask
    config:
      # atools not in config yet when obs_lsst overrides objectTableTractAnalysis
      atools.wPerpPSF.process.buildActions.x.extinctionCoeffs: parameters.extinctionCoeffs
      atools.wPerpPSF.process.buildActions.y.extinctionCoeffs: parameters.extinctionCoeffs
      atools.xPerpPSF.process.buildActions.x.extinctionCoeffs: parameters.extinctionCoeffs
      atools.xPerpPSF.process.buildActions.y.extinctionCoeffs: parameters.extinctionCoeffs
      atools.yPerpPSF.process.buildActions.x.extinctionCoeffs: parameters.extinctionCoeffs
      atools.yPerpPSF.process.buildActions.y.extinctionCoeffs: parameters.extinctionCoeffs
      atools.wPerpCModel.process.buildActions.x.extinctionCoeffs: parameters.extinctionCoeffs
      atools.wPerpCModel.process.buildActions.y.extinctionCoeffs: parameters.extinctionCoeffs
      atools.xPerpCModel.process.buildActions.x.extinctionCoeffs: parameters.extinctionCoeffs
      atools.xPerpCModel.process.buildActions.y.extinctionCoeffs: parameters.extinctionCoeffs
      atools.yPerpCModel.process.buildActions.x.extinctionCoeffs: parameters.extinctionCoeffs
      atools.yPerpCModel.process.buildActions.y.extinctionCoeffs: parameters.extinctionCoeffs
