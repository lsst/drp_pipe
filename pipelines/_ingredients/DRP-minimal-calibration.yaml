description: |
  Base Pipeline for Data Release Production process, with only simple
  single-epoch calibration and characterizations.

  Never run this pipeline or any of its subsets directly; always use those in
  the 'pipelines' directory (or create a custom one) instead.

imports:
  - location: $MEAS_EXTENSIONS_MULTIPROFIT_DIR/pipelines/multiprofit_fit_standard.yaml

tasks:
  isr: lsst.ip.isr.IsrTask
  calibrateImage:
    class: lsst.pipe.tasks.calibrateImage.CalibrateImageTask
    config:

      # In DRP not calibrating the pixels (or the backgrounds) until we have
      # our final photometric calibration makes everything downstream much
      # simpler.
      do_calibrate_pixels: false

      # TODO[DM-47320]: for now we rename outputs to look like those of the
      # tasks calibrateImage replaces; we'll change the input connection
      # defaults downstream later and then remove these overrides.
      connections.initial_stars_schema: src_schema
      connections.stars_footprints: src
      connections.stars: source
      connections.exposure: calexp
      connections.background: calexpBackground

      python: |
        # TODO[DM-47320]: make output catalog as similar to the old 'src' as
        # possible; we'll try to go back to calibrateImage defaults with a
        # smaller catalog after it's integrated.
        # Goal is to remove all of these overrides except the aperture radii,
        # which we instead want to set to the same as the compensated tophat
        # radii below for lsst.fgcmcal.fgcmOutputProducts.FgcmOutputProductsTask
        config.star_detection.includeThresholdMultiplier = 1.0
        config.star_selector["science"].doUnresolved = False
        config.star_selector["science"].doSignalToNoise = False
        config.star_measurement.plugins["base_CircularApertureFlux"].radii = [
            3.0, 6.0, 9.0, 12.0, 17.0, 25.0, 35.0, 50.0, 70.0
        ]
        config.star_measurement.plugins.names |= [
          "base_Variance",
          "ext_shapeHSM_HsmPsfMomentsDebiased",
          "ext_shapeHSM_HsmShapeRegauss",
          "base_Blendedness",
          "base_Jacobian",
        ]

        # fgcmcal needs an inner and outer aperture and may want an estimate of
        # the local background
        config.star_measurement.plugins["base_CircularApertureFlux"].maxSincRadius = 12.0
        config.star_measurement.plugins["base_CompensatedTophatFlux"].apertures = [12, 17]
        config.star_measurement.plugins.names |= ["base_LocalBackground"]

  transformSourceTable:
    class: lsst.pipe.tasks.postprocess.TransformSourceTableTask
    config:
      functorFile: $PIPE_TASKS_DIR/schemas/PreSource.yaml
  consolidateSourceTable: lsst.pipe.tasks.postprocess.ConsolidateSourceTableTask
  consolidateVisitSummary: lsst.pipe.tasks.postprocess.ConsolidateVisitSummaryTask
  isolatedStarAssociation:
    class: lsst.pipe.tasks.isolatedStarAssociation.IsolatedStarAssociationTask
    config:
      # TODO DM-43077: Remove this connection override if preSources are
      # introduced to the imSim pipelines
      # presource are the default catalog to match on
      connections.source_table_visit: sourceTable_visit
  finalizeCharacterization: lsst.pipe.tasks.finalizeCharacterization.FinalizeCharacterizationTask
  updateVisitSummary: lsst.drp.tasks.update_visit_summary.UpdateVisitSummaryTask
  reprocessVisitImage:
    class: lsst.drp.tasks.reprocess_visit_image.ReprocessVisitImageTask
    config:
      connections.background_1: calexpBackground
      remove_initial_photo_calib: false
  makeCcdVisitTable: lsst.pipe.tasks.postprocess.MakeCcdVisitTableTask
  makeVisitTable: lsst.pipe.tasks.postprocess.MakeVisitTableTask
  makeDirectWarp: lsst.drp.tasks.make_direct_warp.MakeDirectWarpTask
  makePsfMatchedWarp: lsst.drp.tasks.make_psf_matched_warp.MakePsfMatchedWarpTask
  selectDeepCoaddVisits:
    class: lsst.pipe.tasks.selectImages.BestSeeingSelectVisitsTask
    config:
      connections.goodVisits: deepCoaddVisits
      # Maximum sensible default psf fwhm in arcseconds to use for a coadd
      maxPsfFwhm: 2.0
      # By default for deep coadds, use all input visits better than maxPsfFwhm
      nVisitsMax: -1
  assembleCoadd:
    class: lsst.drp.tasks.assemble_coadd.CompareWarpAssembleCoaddTask
    config:
      doInputMap: true
      doSelectVisits: true
      doWriteArtifactMasks: true
      assembleStaticSkyModel.doSelectVisits: true
      connections.selectedVisits: deepCoaddVisits
  healSparsePropertyMaps: lsst.pipe.tasks.healSparseMapping.HealSparsePropertyMapTask
  consolidateHealSparsePropertyMaps: lsst.pipe.tasks.healSparseMapping.ConsolidateHealSparsePropertyMapTask
  detection: lsst.pipe.tasks.multiBand.DetectCoaddSourcesTask
  mergeDetections: lsst.pipe.tasks.mergeDetections.MergeDetectionsTask
  deblend: lsst.pipe.tasks.deblendCoaddSourcesPipeline.DeblendCoaddSourcesMultiTask
  measure: lsst.pipe.tasks.multiBand.MeasureMergedCoaddSourcesTask
  mergeMeasurements: lsst.pipe.tasks.mergeMeasurements.MergeMeasurementsTask
  writeObjectTable: lsst.pipe.tasks.postprocess.WriteObjectTableTask
  transformObjectTable: lsst.pipe.tasks.postprocess.TransformObjectCatalogTask
  consolidateObjectTable: lsst.pipe.tasks.postprocess.ConsolidateObjectTableTask
  forcedPhotCcd:
    class: lsst.meas.base.forcedPhotCcd.ForcedPhotCcdTask
    config:
      connections.exposure: pvi
      useVisitSummary: false
  forcedPhotCoadd: lsst.drp.tasks.forcedPhotCoadd.ForcedPhotCoaddTask
  selectGoodSeeingVisits:
    class: lsst.pipe.tasks.selectImages.BestSeeingQuantileSelectVisitsTask
    config:
      connections.goodVisits: goodSeeingVisits
  templateGen:
    class: lsst.drp.tasks.assemble_coadd.CompareWarpAssembleCoaddTask
    config:
      doSelectVisits: true
      assembleStaticSkyModel.doSelectVisits: true
      doNImage: true
      connections.selectedVisits: goodSeeingVisits
      connections.outputCoaddName: goodSeeing
      # Setting template 'outputCoaddName' to goodSeeing is not sufficient to
      # convince contract checker that coaddExposure == goodSeeingCoadd
      connections.coaddExposure: goodSeeingCoadd
  getTemplate:
    class: lsst.ip.diffim.getTemplate.GetTemplateTask
    config:
      connections.bbox: pvi.bbox
      connections.wcs: pvi.wcs
      connections.coaddName: goodSeeing
      connections.coaddExposures: goodSeeingCoadd
      connections.template: goodSeeingDiff_templateExp
  subtractImages:
    class: lsst.ip.diffim.subtractImages.AlardLuptonSubtractTask
    config:
      allowKernelSourceDetection: true
      connections.science: pvi
      connections.coaddName: goodSeeing
      connections.template: goodSeeingDiff_templateExp
      connections.difference: goodSeeingDiff_differenceTempExp
      connections.matchedTemplate: goodSeeingDiff_matchedExp
  detectAndMeasureDiaSources:
    class: lsst.ip.diffim.detectAndMeasure.DetectAndMeasureTask
    config:
      connections.science: pvi
      connections.coaddName: goodSeeing
      connections.matchedTemplate: goodSeeingDiff_matchedExp
      connections.difference: goodSeeingDiff_differenceTempExp
      connections.subtractedMeasuredExposure: goodSeeingDiff_differenceExp
  rbClassify:
    class: lsst.meas.transiNet.RBTransiNetTask
    config:
      modelPackageStorageMode: butler
      connections.science: pvi
      connections.coaddName: goodSeeing
      connections.template: goodSeeingDiff_templateExp
      connections.difference: goodSeeingDiff_differenceTempExp
      connections.diaSources: goodSeeingDiff_diaSrc
  transformDiaSourceCat:
    class: lsst.ap.association.TransformDiaSourceCatalogTask
    config:
      doIncludeReliability: true
      connections.coaddName: goodSeeing
      connections.diaSourceSchema: goodSeeingDiff_diaSrc_schema
      connections.diaSourceCat: goodSeeingDiff_diaSrc
      connections.diffIm: goodSeeingDiff_differenceExp
      connections.diaSourceTable: goodSeeingDiff_diaSrcTable
  consolidateDiaSourceTable:
    class: lsst.pipe.tasks.postprocess.ConsolidateSourceTableTask
    config:
      connections.inputCatalogs: goodSeeingDiff_diaSrcTable
      connections.outputCatalog: diaSourceTable
  drpAssociation:
    class: lsst.pipe.tasks.drpAssociationPipe.DrpAssociationPipeTask
    config:
      connections.coaddName: goodSeeing
      connections.diaSourceTables: goodSeeingDiff_diaSrcTable
      connections.assocDiaSourceTable: goodSeeingDiff_assocDiaSrcTable
      connections.diaObjectTable: goodSeeingDiff_diaObjTable
  drpDiaCalculation:
    class: lsst.pipe.tasks.drpDiaCalculationPipe.DrpDiaCalculationPipeTask
    config:
      connections.coaddName: goodSeeing
      connections.assocDiaSourceTable: goodSeeingDiff_assocDiaSrcTable
      connections.diaObjectTable: goodSeeingDiff_diaObjTable
      connections.fullDiaObjectTable: goodSeeingDiff_fullDiaObjTable
  consolidateAssocDiaSourceTable:
    class: lsst.pipe.tasks.postprocess.ConsolidateTractTask
    config:
      connections.inputCatalogs: goodSeeingDiff_assocDiaSrcTable
      connections.outputCatalog: diaSourceTable_tract
  consolidateFullDiaObjectTable:
    class: lsst.pipe.tasks.postprocess.ConsolidateTractTask
    config:
      connections.inputCatalogs: goodSeeingDiff_fullDiaObjTable
      connections.outputCatalog: diaObjectTable_tract
  forcedPhotDiffim:
    class: lsst.meas.base.ForcedPhotCcdTask
    config:
      connections.measCat: forced_diff
      connections.outputSchema: forced_diff_schema
      connections.exposure: goodSeeingDiff_differenceExp
      useVisitSummary: false  # difference image already has final calibrations
  writeForcedSourceTable: lsst.pipe.tasks.postprocess.WriteForcedSourceTableTask
  transformForcedSourceTable: lsst.pipe.tasks.postprocess.TransformForcedSourceTableTask
  consolidateForcedSourceTable:
    class: lsst.pipe.tasks.postprocess.ConsolidateTractTask
    config:
      connections.inputCatalogs: forcedSourceTable
      connections.outputCatalog: forcedSourceTable_tract
  forcedPhotCcdOnDiaObjects:
    class: lsst.meas.base.ForcedPhotCcdFromDataFrameTask
    config:
      connections.exposure: pvi
      useVisitSummary: false
  forcedPhotDiffOnDiaObjects:
    class: lsst.meas.base.ForcedPhotCcdFromDataFrameTask
    config:
      connections.measCat: forced_diff_diaObject
      connections.outputSchema: forced_diff_diaObject_schema
      connections.exposure: goodSeeingDiff_differenceExp
      useVisitSummary: false  # difference image already has final calibrations
  writeForcedSourceOnDiaObjectTable:
    class: lsst.pipe.tasks.postprocess.WriteForcedSourceTableTask
    config:
      key: diaObjectId
      connections.inputCatalogDiff: forced_diff_diaObject
      connections.inputCatalog: forced_src_diaObject
      connections.outputCatalog: mergedForcedSourceOnDiaObject
  transformForcedSourceOnDiaObjectTable:
    class: lsst.pipe.tasks.postprocess.TransformForcedSourceTableTask
    config:
      referenceColumns: []
      keyRef: diaObjectId
      key: forcedSourceOnDiaObjectId
      connections.inputCatalogs: mergedForcedSourceOnDiaObject
      connections.outputCatalog: forcedSourceOnDiaObjectTable
      connections.referenceCatalog: goodSeeingDiff_fullDiaObjTable
  consolidateForcedSourceOnDiaObjectTable:
    class: lsst.pipe.tasks.postprocess.ConsolidateTractTask
    config:
      connections.inputCatalogs: forcedSourceOnDiaObjectTable
      connections.outputCatalog: forcedSourceOnDiaObjectTable_tract
subsets:
  # This pipeline file only defines subsets that have a consistent or
  # near-consistent definition as a set of tasks, for use by downstream
  # pipelines as way to include or exclude those tasks.  It does not (and
  # should not) contain "step" subsets aimed at splitting up a processing
  # campaign.
  processCcd:
    subset:
      - isr
      - calibrateImage
    description: >
      Set of tasks to run when doing single frame processing, without any
      conversions to Parquet/DataFrames or visit-level summaries.
  sourceTable:
    subset:
      - transformSourceTable
      - consolidateSourceTable
    description: >
      Set of tasks to generate parquet Source Tables from output of processCcd
      subset.
  coaddition:
    subset:
      - makeDirectWarp
      - makePsfMatchedWarp
      - assembleCoadd
      - healSparsePropertyMaps
    description: >
      A set of tasks to run when coadding images.
  multiband:
    subset:
      - detection
      - mergeDetections
      - deblend
      - measure
      - mergeMeasurements
      - forcedPhotCoadd
    description: >
      A set of tasks to run when making measurements on coadds.
  objectTable:
    subset:
      - writeObjectTable
      - transformObjectTable
      - consolidateObjectTable
    description: >
      A set of tasks to transform multiband outputs into a parquet object
      table.
  forced:
    subset:
      - forcedPhotCcd
      - forcedPhotCoadd
    description: >
      A set of tasks to run when doing forced measurements.
  diffimDRP:
    subset:
      - selectGoodSeeingVisits
      - templateGen
      - getTemplate
      - subtractImages
      - detectAndMeasureDiaSources
      - rbClassify
      - transformDiaSourceCat
      - consolidateDiaSourceTable
      - drpAssociation
      - drpDiaCalculation
      - forcedPhotDiffim
      - forcedPhotCcdOnDiaObjects
      - forcedPhotDiffOnDiaObjects
    description: >
      Subset for running image differencing branch of the DRP pipeline

contracts:
  - selectGoodSeeingVisits.connections.goodVisits == templateGen.connections.selectedVisits
  - templateGen.connections.coaddExposure == getTemplate.connections.coaddExposures
  - getTemplate.connections.template == subtractImages.connections.template
  - subtractImages.connections.matchedTemplate == detectAndMeasureDiaSources.connections.matchedTemplate
  - subtractImages.connections.difference == detectAndMeasureDiaSources.connections.difference
  - detectAndMeasureDiaSources.connections.subtractedMeasuredExposure == transformDiaSourceCat.connections.diffIm
  - detectAndMeasureDiaSources.connections.subtractedMeasuredExposure == forcedPhotDiffim.connections.exposure
  - transformDiaSourceCat.connections.diaSourceTable == consolidateDiaSourceTable.connections.inputCatalogs
  - transformDiaSourceCat.connections.diaSourceTable == drpAssociation.connections.diaSourceTables
  - drpAssociation.connections.assocDiaSourceTable == drpDiaCalculation.connections.assocDiaSourceTable
  - drpAssociation.connections.diaObjectTable == drpDiaCalculation.connections.diaObjectTable
  - forcedPhotDiffim.connections.refCat == forcedPhotCcd.connections.refCat
  - consolidateHealSparsePropertyMaps.property_maps == healSparsePropertyMaps.property_maps
  - "'calib_psf_candidate' not in measure.propagateFlags.source_flags if makeDirectWarp.useVisitSummaryPsf else True"
  - "'calib_psf_used' not in measure.propagateFlags.source_flags if makeDirectWarp.useVisitSummaryPsf else True"
  - "'calib_psf_reserved' not in measure.propagateFlags.source_flags if makeDirectWarp.useVisitSummaryPsf else True"
  - "makeDirectWarp.warper.cacheSize == assembleCoadd.coaddPsf.cacheSize"
  - "makeDirectWarp.border >= makePsfMatchedWarp.psfMatch.kernel.active.sizeCellX"
  - "makeDirectWarp.border >= makePsfMatchedWarp.psfMatch.kernel.active.sizeCellY"
