description: The DRP pipeline specialized for large data release productions
imports:
  - location: "$DRP_PIPE_DIR/pipelines/_ingredients/HSC/DRP.yaml"
    labeledSubsetModifyMode: EDIT
    exclude:
    - preliminary_observation_tables
    - dia
    - step5
    - step6
    # TODO[DM-47010] these tasks were not previously included in steps, but
    # it's unclear whether their omission was intentional.
    - analyzeCalibrateMetadata
    - calexpSummary
    - analyzeMatchedVisitExtended
    - objectEpochTable
    - catalogMatchVisit
    - astrometricRefCatSourceVisit
    - photometricMatchVisit
    - photometricRefCatSourceVisit
    - analysis_drp_plots
tasks:
  fgcmFitCycle:
    class: lsst.fgcmcal.fgcmFitCycle.FgcmFitCycleTask
    config:
      useExposureReferenceOffset: true
      multipleCyclesFinalCycleNumber: 6
  fgcmOutputProducts:
    class: lsst.fgcmcal.fgcmOutputProducts.FgcmOutputProductsTask
    config:
      connections.cycleNumber: 6
subsets:
  step2a:
    subset:
      - consolidatePreSourceTable
      - consolidateVisitSummary
      - skyCorr
    description: |
      Visit-level tasks
      Allowed data query constraints: visit

      Tasks aggregate all detectors for a given visit and perform
      full focal plane background estimation.
  step2b:
    subset:
      - isolatedStarAssociation
      - analyzeMatchedPreVisitCore
      - gbdesAstrometricFit
    description: |
      Tract-level tasks
      Allowed data query constraints: tract

      GbdesAstrometricFit and isolatedStarAssociation both use PreSources,
      generated by consolidatePreSourceTable, for all visits that overlap a
      tract.
      gbdesAstrometricFit produces solutions per-tract, per-visit
      isolatedStarAssociation produces solutions per-tract.
  step2c:
    subset:
      - fgcmBuildFromIsolatedStars
      - fgcmFitCycle
      - fgcmOutputProducts
    description: |
      Global-level tasks that must not be run with any data query constraints
      Can be run anytime after subset step2a.

      Allowed data query constraints: instrument

      Tasks generate one data product per collection.
      FGCM performs better the more visits are included and
      make[Ccd]VisitTable produces per-collection summary of the Visits
      and CcdVisits.
  step2d:
    subset:
      - finalizeCharacterization
      - transformSourceTable
      - consolidateSourceTable
      - updateVisitSummary
      - reprocessVisitImage
      - analyzeSourceTableCore
    description: |
      Visit-level tasks.
      Allowed data query constraints: visit

      transformSourceTable and reprocessVisitImage run per-detector.
      consolidateSourceTable produces one data product per visit.
      finalizeCharacterization will eventually model full focal plane PSFs.
  step2e:
    subset:
      - makeCcdVisitTable
      - makeVisitTable
    description: |
      Global-level tasks that must not be run with any data query constraints
      Can be run anytime after subset step2d.

      Allowed data query constraints: instrument

      Tasks generate one data product per collection.
      make[Ccd]VisitTable produces per-collection summary of the Visits
      and CcdVisits.
  # step3 is imported.
  # step4 is imported, but most tasks are dropped because the 'dia' subset is
  # excluded.
  # step5 and step6 are intentionally excluded from the import.
  # step7 is imported.