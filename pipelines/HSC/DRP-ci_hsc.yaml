description: The DRP pipeline specialized for the ci_hsc test dataset.
instrument: lsst.obs.subaru.HyperSuprimeCam
imports:
  - location: $DRP_PIPE_DIR/ingredients/HSC/DRP.yaml
    exclude:
      # Don't run jointcal, fgcm, or (some of) faro, as there isn't enough data.
      - fgcm
      - jointcal
      - faro_all
  - $ANALYSIS_TOOLS_DIR/pipelines/coaddQualityExtended.yaml
  - $ANALYSIS_TOOLS_DIR/pipelines/visitQualityCore.yaml
tasks:
  makeWarp:
    class: lsst.pipe.tasks.makeCoaddTempExp.MakeWarpTask
    config:
      # Do expect jointcal's photoCalibs to be present even though we didn't
      # run it, since that's what the testdata_ci_hsc repo is set up to have.
      # That's not realistic overall, but it does let us test the code paths
      # downstream of coaddition that we use most often.
      # See also forcedPhotCcd, forcedPhotCcdOnDiaObjects, forcedPhotDiffim,
      # forcedPhotDiffOnDiaObjects.
      connections.photoCalibName: "jointcal"
      useGlobalExternalPhotoCalib: false
  deblend:
    class: lsst.pipe.tasks.deblendCoaddSourcesPipeline.DeblendCoaddSourcesMultiTask
    # Significantly limit the number of sources to deblend, which saves time
    # in both deblending and measurement
    config:
      # Only run the deblender on a small subset of blended parents
      multibandDeblend.useCiLimits: true
      # Do not run the deblender on isolated sources
      multibandDeblend.processSingles: false
  calibrate:
    class: lsst.pipe.tasks.calibrate.CalibrateTask
    # Significantly limit the number of sources to deblend, which saves time
    # in both deblending and measurement
    config:
      # Only run the deblender on a small subset of blended parents
      deblend.useCiLimits: true
  subtractImages:
    class: lsst.ip.diffim.subtractImages.AlardLuptonSubtractTask
    # Increase required area of usable template so we raise NoWorkFound
    # instead of bringing down execution.
    config:
      requiredTemplateFraction: 0.2
  forcedPhotCcd:
    class: lsst.meas.base.forcedPhotCcd.ForcedPhotCcdTask
    config:
      connections.photoCalibName: "jointcal"
      useGlobalExternalPhotoCalib: false
  forcedPhotDiffim:
    class: lsst.meas.base.ForcedPhotCcdTask
    config:
      connections.photoCalibName: "jointcal"
      useGlobalExternalPhotoCalib: false
  writeRecalibratedSourceTable:
    class: lsst.pipe.tasks.postprocess.WriteRecalibratedSourceTableTask
    config:
      useGlobalExternalPhotoCalib: false
      connections.photoCalibName: "jointcal"
      connections.outputCatalog: source
  isolatedStarAssociation:
    class: lsst.pipe.tasks.isolatedStarAssociation.IsolatedStarAssociationTask
    config:
      band_order: ['i', 'r']
  analyzeObjectTableCore:
    class: lsst.analysis.tools.tasks.ObjectTableTractAnalysisTask
    config:
      bands: ['r', 'i',]
  analyzeObjectTableExtended:
    class: lsst.analysis.tools.tasks.ObjectTableTractAnalysisTask
    config:
      bands: ['r', 'i',]
