description: |
  DRP-flavored pipeline to support validation
  during commissioning, and will help inform
  what changes to make the following night. Detector and Visit
  level tasks can be run in real time by e.g. Rapid Analysis.
  The rest of the pipeline is expected to be run as part of the
  10am processing.
instrument: lsst.obs.lsst.LsstComCamSim
imports:
  - $DRP_PIPE_DIR/pipelines/_ingredients/LSSTComCamSim/DRP.yaml
tasks:
  analyzePreSourceTableCore:
    class: lsst.analysis.tools.tasks.SourceTableVisitAnalysisTask
    config:
      connections.data: preSourceTable_visit
      connections.inputName: preSourceTable_visit
      connections.outputName: preSourceTableCore
  calibrate:
    class: lsst.pipe.tasks.calibrate.CalibrateTask
    config:
      python: |
        from lsst.analysis.tools.tasks import CalexpSummaryAnalysisTask
        config.createSummaryMetrics.retarget(CalexpSummaryAnalysisTask)
        from lsst.analysis.tools.atools import CalexpSummaryMetrics
        config.createSummaryMetrics.atools.calexpSummaryMetrics = CalexpSummaryMetrics
      doCreateSummaryMetrics: true
  updateVisitSummary:
    class: lsst.drp.tasks.update_visit_summary.UpdateVisitSummaryTask
    config:
      # No global calibration during nightly validation
      wcs_provider: "input_summary"
      photo_calib_provider: "input_summary"
      background_provider: "input_summary"
subsets:
  # These 3 steps can be run in real time by Rapid Analysis Framework at USDF
  step1:
    subset:
      - isr
      - characterizeImage
      - calibrate
      - writePreSourceTable
      - transformPreSourceTable
    description: |
      Detector level tasks. TO DO: requests include synthetic source injection,
      subtractImages, detectAndMeasureDiaSources.
  step2a:
    subset:
      - consolidatePreSourceTable
      - consolidateVisitSummary
      - analyzePreSourceTableCore
      - catalogMatchPreVisit
      - astrometricRefCatPreSourceVisit
      # TO DO: Add photometricMatchPreVisit, photometricRefCatPreSourceVisit
    description: Visit-level tasks
  nightlyRollup:
    subset:
      - makePreliminaryCcdVisitTable
      - makePreliminaryVisitTable
      - preliminaryVisitCoverageAnalysis
    description: |
      Global tasks that can be run at end of night or multiple times during
      the night, to get a summary of observations taken.
  # The following N steps should be run once at the end of the night
  # A complete pipeline (without DIA): step2b,step2d,step2e,step3,step7
  step2b:
    subset:
      - isolatedStarAssociation
    description: |
      Tract-level tasks
      Allowed data query constraints: tract

      isolatedStarAssociation uses PreSources,
      generated by consolidatePreSourceTable, for all visits that overlap a
      tract.
  step2d:
    subset:
      - finalizeCharacterization
      - transformSourceTable
      - consolidateSourceTable
      - updateVisitSummary
      - reprocessVisitImage
    description: |
      Visit-level tasks.
      Allowed data query constraints: visit

      reprocessVisitImage, transformSourceTable run per-detector.
      consolidateSourceTable produces one data product per visit.
      finalizeCharacterization will eventually model full focal plane PSFs.
  step2e:
    subset:
      - makeCcdVisitTable
      - makeVisitTable
    description: |
      Global-level tasks that must not be run with any data query constraints
      Can be run anytime after subset step2d.

      Allowed data query constraints: instrument

      Tasks generate one data product per collection.
      make[Ccd]VisitTable produces per-collection summary of the Visits
      and CcdVisits.
  step3:
    subset:
      - makeWarp
      - selectDeepCoaddVisits
      - assembleCoadd
      - detection
      - mergeDetections
      - deblend
      - measure
      - mergeMeasurements
      - forcedPhotCoadd
      - transformObjectTable
      - writeObjectTable
      - consolidateObjectTable
      - healSparsePropertyMaps
      # analysis_tools tasks
      - analyzeAmpOffsetMetadata
      - isolatedStarSourceAssociation
      - analyzeMatchedVisitCore
      - analyzeObjectTableCore
      - analyzeObjectTableExtended
      - catalogMatchTract
      - photometricCatalogMatch
      - photometricRefCatObjectTract
      - plotPropertyMapTract
      - refCatObjectTract
      - validateObjectTableCore
    description: |
      This overrides the default DRP pipeline by not making nightly templates.
      We may want to make daily templates in the future.

      Patch and Tract-level tasks that make coadds and object tables that
      can be run together, but only after the 'step1' and 'step2d'
      subsets.
  step7:
    subset:
      - consolidateHealSparsePropertyMaps
      - analyzeObjectTableSurveyCore
      - makeMetricTableMatchedVisitCore
      - makeMetricTableObjectTableCore
      - matchedVisitCoreWholeSkyPlot
      - objectTableCoreWholeSkyPlot
    description: |
      Tasks that should be run as the final step that require global inputs,
      and can be run after the 'step3' subset.

      This step has global aggregation tasks to run over all visits, detectors,
      tracts, etc.  This step should be run only with the instrument constraint
      in the data query.
