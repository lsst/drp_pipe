description: LSSTCam specialization of the DRP pipeline
instrument: lsst.obs.lsst.LsstCam
imports:
  - location: $DRP_PIPE_DIR/pipelines/_ingredients/base-v2.yaml
    labeledSubsetModifyMode: EDIT
    exclude:
      - analysis-visit-initial
      - analysis-visit-recalibrated
      - analysis-visit-source
      # TODO: DM-50154. FGCM starts turned off
      - fgcmBuildFromIsolatedStar
      - fgcmFitCycle
      - fgcmOutputProducts
tasks:
  updateVisitSummary:
    class: lsst.drp.tasks.update_visit_summary.UpdateVisitSummaryTask
    config:
      # TODO: DM-50154. FGCM starts turned off
      photo_calib_provider: input_summary
      background_provider: input_summary
      connections.background_originals: preliminary_visit_image_background
  selectTemplateCoaddVisits:
    class: lsst.pipe.tasks.selectImages.BestSeeingSelectVisitsTask
    config:
      connections.visitSummaries: visit_summary
      connections.goodVisits: template_coadd_visit_selection
      maxPsfFwhm: 1.4
      python: |
        config.visitSummaryMinValues = {'effTimeZeroPointScale': 0.75}
  selectDeepCoaddVisits:
    class: lsst.pipe.tasks.selectImages.BestSeeingSelectVisitsTask
    config:
      maxPsfFwhm: 1.7
      python: |
        config.visitSummaryMinValues = {'effTimeZeroPointScale': 0.75}
  splitPrimarySource:
    class: lsst.pipe.tasks.split_primary.SplitPrimaryTask
    config:
      connections.primary: source2
  detectCoaddPeaks:
    class: lsst.pipe.tasks.multiBand.DetectCoaddSourcesTask
    config:
      # As of w_2025_30 DRP, lowest number of skyObjects seen is 9
      # 9/0.02 = 450.
      detection.skyObjects.nSources: 400
      # Start with HSC configs and then refine
      detection.doTempWideBackground: true
      detection.tempWideBackground.binSize: 128
      detection.tempWideBackground.useApprox: false
      detection.reEstimateBackground: true
      detection.background.binSize: 128
      detection.background.useApprox: false
