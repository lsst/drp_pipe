description: >
  LSSTCam specialization of the Nightly Validation Pipeline.
  Run overnight: step1a-single-visit-detectors, step1b-single-visit-visits
  Run in morning: step1c-single-visit-tracts,step1d-single-visit-global,stage3-coadd

  This is the cheapest possible version of a Nightly Validation pipeline.
  It excludes PIFF and Object Table generation.

  This pipeline does not produce sources and is compatible with
  data repositories with either source and source2 dataset types.

instrument: lsst.obs.lsst.LsstCam
parameters:
  use_cell_coadds: false
  # Setting it to true is not sufficient to use cell coadds.
  # assembleCellCoadd needs to be removed from the exclude list below.
imports:
  - location: $DRP_PIPE_DIR/pipelines/_ingredients/base-v2.yaml
    labeledSubsetModifyMode: EDIT
    exclude:
      # unlike DRP.yaml, do run all analysis-visit-initial tasks, but remove:
      - analysis-visit-recalibrated
      - analysis-visit-source
      # Remove entire recalibration stage including PIFF
      - stage2-recalibrate
      - stage4-measure-variability
      # Remove cell-based coadds
      - assembleCellCoadd
      # Remove template generation
      - selectTemplateCoaddVisits
      - assembleTemplateCoadd
      - makeTemplateCoaddInputSummaryTract
      - makeTemplateCoaddInputSummary
      # Remove object table generation
      - mergeObjectDetection
      - deconvolve
      - deblendCoaddFootprints
      - measureObjectUnforced
      - mergeObjectMeasurement
      - measureObjectForced
      - fitDeepCoaddPsfGaussians
      - fitDeblendedObjectsExp
      - fitDeblendedObjectsSersic
      - rewriteObject
      - standardizeObject
      - consolidateObject
      - consolidateParentTable
      - splitPrimaryObject
      - metadetectionShear
      - consolidateShearObject
      - analyzeObjectTableCore
      - analyzeObjectParentTableCore
      - catalogMatchTract
      - refCatObjectTract
      - photometricCatalogMatch
      - photometricRefCatObjectTract
      - plotPropertyMapTract
      - validateObjectTableCore
      - computeObjectEpochs
      - analyzeObjectTableSurveyCore
      - makeBinnedCoaddImage
      - makeWholeTractImage
      - makeBinnedTemplateNImage
      - makeWholeTractTemplateNImage
      - makeBinnedDeepNImage
      - makeWholeTractDeepNImage
      - makeMetricTableObjectTableCore
      - objectTableCoreWholeSkyPlot
      - makeMetricTableObjectParentTableCore
      - objectParentTableCoreWholeSkyPlot
      - makeMetricTableObjectTableCoreRefCatMatch
      - objectTableCoreRefCatMatchWholeSkyPlot
# If you add any config overrides that overlap with LSSTCam/DRP.yaml,
# please create a pipelines/_ingredients/LSSTCam/DRP.yaml they both share
tasks:
  calibrateImage:
    class: lsst.pipe.tasks.calibrateImage.CalibrateImageTask
    config:
      connections.exposures: post_isr_image
      connections.stars_footprints: single_visit_star_footprints
      connections.psf_stars_footprints: single_visit_psf_star_footprints
      connections.psf_stars: single_visit_psf_star
      connections.initial_stars_schema: single_visit_star_schema
      connections.stars: single_visit_star_unstandardized
      connections.exposure: preliminary_visit_image
      connections.background: preliminary_visit_image_background
      id_generator.release_id: parameters.release_id
      # Don't calibrate pixels to nJy, since we assume quickLook consumers are
      # prefer e- units and that's what they'd get if PhotoCal fails anyway.
      do_calibrate_pixels: false
      astrometry.matcher.maxRefObjects: 2048
      psf_detection.thresholdValue: 50
      do_downsample_footprints: true
      do_include_astrometric_errors: false
      astrometry.maxIter: 2
      compute_summary_stats.psfGridSampling: 250
      useButlerCamera: True
      python: |
        config.star_measurement.plugins.names.add("base_FPPosition")
        config.star_measurement.plugins.names.add("ext_shapeHSM_HigherOrderMomentsSource")
        config.psf_source_measurement.plugins.names.add("ext_shapeHSM_HigherOrderMomentsSource")
        config.psf_measure_psf.starSelector["objectSize"].widthMax = 20.0
        if "slot_Centroid_flag" in config.psf_measure_psf.starSelector["objectSize"].badFlags:
            config.psf_measure_psf.starSelector["objectSize"].badFlags.remove("slot_Centroid_flag")
        config.psf_measure_psf.psfDeterminer["psfex"].rejectFlaggedCentroids = False
  consolidateVisitSummary:
    class: lsst.pipe.tasks.postprocess.ConsolidateVisitSummaryTask
    config:
      full: true
  analyzeAmpInterfaceOffsetMetadata:
    class: lsst.analysis.tools.tasks.DatasetMetadataAnalysisTask
    config:
      connections.inputName: post_isr_image
  makeDirectWarp:
    class: lsst.drp.tasks.make_direct_warp.MakeDirectWarpTask
    config:
      connections.visit_summary: preliminary_visit_summary
  selectDeepCoaddVisits:
    class: lsst.pipe.tasks.selectImages.BestSeeingSelectVisitsTask
    config:
      connections.visitSummaries: preliminary_visit_summary
  makeHealSparsePropertyMaps:
    class: lsst.pipe.tasks.healSparseMapping.HealSparsePropertyMapTask
    config:
      connections.visit_summaries: preliminary_visit_summary
  assembleCellCoadd:
    class: lsst.drp.tasks.assemble_cell_coadd.AssembleCellCoaddTask
    config:
      connections.visitSummaryList: preliminary_visit_summary
