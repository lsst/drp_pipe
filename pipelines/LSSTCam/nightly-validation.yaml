description: |
  DRP-flavored pipeline to support validation
  during commissioning, and will help inform
  what changes to make the following night. Detector and Visit
  level tasks can be run in real time by e.g. Rapid Analysis.
  The rest of the pipeline is expected to be run as part of the
  10am processing.
instrument: lsst.obs.lsst.LsstCam
imports:
  - location: $DRP_PIPE_DIR/pipelines/_ingredients/LSSTCam/DRP.yaml
    labeledSubsetModifyMode: EDIT
    exclude:
      - fgcm
      - multiprofit_fit_standard
      - dia
      - step4
      - step5
      - step6
      # TODO[DM-47010]: exclusion is historical, possibly unintentional
      - analysis_drp_plots
      - exposureQualityCore
      # TODO[DM-47010]: exclusion needed to avoid duplicate outputs.
      - calexpSummary
  # TODO[DM-47010]: inclusion is historical, possibly unintentional
  - $ANALYSIS_TOOLS_DIR/pipelines/coaddQualityExtended.yaml
tasks:
  analyzePreSourceTableCore:
    class: lsst.analysis.tools.tasks.SourceTableVisitAnalysisTask
    config:
      connections.data: preSourceTable_visit
      connections.inputName: preSourceTable_visit
      connections.outputName: preSourceTableCore
  calibrate:
    class: lsst.pipe.tasks.calibrate.CalibrateTask
    config:
      python: |
        from lsst.analysis.tools.tasks import CalexpSummaryAnalysisTask
        config.createSummaryMetrics.retarget(CalexpSummaryAnalysisTask)
        from lsst.analysis.tools.atools import CalexpSummaryMetrics
        config.createSummaryMetrics.atools.calexpSummaryMetrics = CalexpSummaryMetrics
      doCreateSummaryMetrics: true
  analyzeMatchedVisitCore:
    class: lsst.analysis.tools.tasks.AssociatedSourcesTractAnalysisTask
    config:
      # no GBDES fit to produce the astrometric correction.
      applyAstrometricCorrections: false
  updateVisitSummary:
    class: lsst.drp.tasks.update_visit_summary.UpdateVisitSummaryTask
    config:
      # No global calibration during nightly validation
      wcs_provider: "input_summary"
      photo_calib_provider: "input_summary"
      background_provider: "input_summary"
subsets:
  # These 3 steps can be run in real time by Rapid Analysis Framework at USDF
  # step1 is imported.
  step2a:
    subset:
      - consolidatePreSourceTable
      - consolidateVisitSummary
      - analyzePreSourceTableCore
      - catalogMatchPreVisit
      - astrometricRefCatPreSourceVisit
      # TO DO: Add photometricMatchPreVisit, photometricRefCatPreSourceVisit
    description: Visit-level tasks
  nightlyRollup:
    subset:
      - makePreliminaryCcdVisitTable
      - makePreliminaryVisitTable
      - preliminaryVisitCoverageAnalysis
    description: |
      Global tasks that can be run at end of night or multiple times during
      the night, to get a summary of observations taken.
  # The following N steps should be run once at the end of the night
  # A complete pipeline (without DIA): step2b,step2d,step2e,step3,step7
  step2b:
    subset:
      - isolatedStarAssociation
    description: |
      Tract-level tasks
      Allowed data query constraints: tract

      isolatedStarAssociation uses PreSources,
      generated by consolidatePreSourceTable, for all visits that overlap a
      tract.
  step2d:
    subset:
      - finalizeCharacterization
      - transformSourceTable
      - consolidateSourceTable
      - updateVisitSummary
      - reprocessVisitImage
    description: |
      Visit-level tasks.
      Allowed data query constraints: visit

      reprocessVisitImage, transformSourceTable run per-detector.
      consolidateSourceTable produces one data product per visit.
      finalizeCharacterization will eventually model full focal plane PSFs.
  step2e:
    subset:
      - makeCcdVisitTable
      - makeVisitTable
    description: |
      Global-level tasks that must not be run with any data query constraints
      Can be run anytime after subset step2d.

      Allowed data query constraints: instrument

      Tasks generate one data product per collection.
      make[Ccd]VisitTable produces per-collection summary of the Visits
      and CcdVisits.
  # step3 is imported, with one addition.
  +step3:
    subset:
      - analyzeObjectTableExtended
  # steps 4-6 are intentionally excluded from the import.
  # step7 is imported.